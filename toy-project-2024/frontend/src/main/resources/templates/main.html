<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>임민석의 토이 프로젝트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-sm bg-light">
            <ul class="navbar-nav">
                <li class="nav-item" style="cursor: pointer;">
                    <a class="nav-link" id="logout-button">로그아웃</a>
                </li>
            </ul>
        </nav>
        <div style="margin-top: 50px;">
            <h1>메인 페이지</h1>
            <div class="col-md-4" style="margin-top: 100px;">
                <button id="google-link-button" style="display: none;" class="btn btn-primary">
                    <a href="/oauth2/authorization/google" style="color: white; text-decoration: none">구글 연동</a>
                </button>
                <button id="kakao-link-button" style="display: none;" class="btn btn-primary">
                    <a href="/oauth2/authorization/kakao" style="color: white; text-decoration: none">카카오 연동</a>
                </button>
                <button id="naver-link-button" style="display: none;" class="btn btn-primary">
                    <a href="/oauth2/authorization/naver" style="color: white; text-decoration: none">네이버 연동</a>
                </button>
            </div>
            <div class="col-md-4" style="margin-top: 100px;">
                <button id="google-unlink-button" data-social-type="GOOGLE" style="display: none;"
                        class="btn btn-warning">구글 연동 해제
                </button>
                <button id="kakao-unlink-button" data-social-type="KAKAO" style="display: none;"
                        class="btn btn-warning">카카오 연동 해제
                </button>
                <button id="naver-unlink-button" data-social-type="NAVER" style="display: none;"
                        class="btn btn-warning">네이버 연동 해제
                </button>
            </div>
        </div>
    </div>
    <section th:insert="~{layout/jsImport::jsImport}"></section>
    <script th:inline="javascript">
        window.onload = function () {
            setMemberInfoIntoLocalStorage()
                .then(() => {
                    const memberInfo = getMemberInfo();
                    displayLinkButtons(memberInfo);
                    displayUnlinkButtons(memberInfo);
                });
        };

        document.getElementById('logout-button').addEventListener('click', logout);
        document.querySelectorAll('[data-social-type]').forEach(button => {
            button.addEventListener('click', deleteSocialLink);
        });

        function setMemberInfoIntoLocalStorage() {
            return requestToApi('/members/me', 'GET', null, response => localStorage.setItem('memberInfo', JSON.stringify(response.data)));
        }

        function displayLinkButtons(memberInfo) {
            if (!memberInfo.socialTypes.includes('GOOGLE')) {
                document.getElementById('google-link-button').style.display = 'inline';
            }
            if (!memberInfo.socialTypes.includes('KAKAO')) {
                document.getElementById('kakao-link-button').style.display = 'inline';
            }
            if (!memberInfo.socialTypes.includes('NAVER')) {
                document.getElementById('naver-link-button').style.display = 'inline';
            }
        }

        function displayUnlinkButtons(memberInfo) {
            if (memberInfo.socialTypes.includes('GOOGLE')) {
                document.getElementById('google-unlink-button').style.display = 'inline';
            }
            if (memberInfo.socialTypes.includes('KAKAO')) {
                document.getElementById('kakao-unlink-button').style.display = 'inline';
            }
            if (memberInfo.socialTypes.includes('NAVER')) {
                document.getElementById('naver-unlink-button').style.display = 'inline';
            }
        }

        function logout() {
            axios.post(apiBaseUrl + '/logout', {
                accessToken: localStorage.getItem('accessToken'),
                refreshToken: localStorage.getItem('refreshToken')
            }).then(response => {
                clearLocalStorage();
                window.location.href = '/login';
            }).catch(error => {
                if (error.response.status === 401) {
                    clearLocalStorage();
                    window.location.href = '/login';
                } else {
                    alert('로그아웃 실패');
                }
            });
        }

        function clearLocalStorage() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('memberInfo');
        }

        function deleteSocialLink(event) {
            const socialType = event.target.getAttribute('data-social-type');
            return requestToApi('/members/me/social-links/' + socialType, 'DELETE', null, response => {
                alert('소셜 연동 해제가 완료되었습니다.')
                location.reload();
            });
        }
    </script>
</body>
</html>
